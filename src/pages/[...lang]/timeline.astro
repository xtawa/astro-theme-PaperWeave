---
import { getCollection } from 'astro:content'
import { allLocales } from '@/config'
import { getLangFromLocale, getLangRouteParam } from '@/i18n/lang'
import { getPostPath } from '@/i18n/path'
import { ui } from '@/i18n/ui'
import Layout from '@/layouts/Layout.astro'

export async function getStaticPaths() {
  return allLocales.map(lang => ({
    params: { lang: getLangRouteParam(lang) },
  }))
}

const currentLang = getLangFromLocale(Astro.currentLocale)
const currentUI = ui[currentLang as keyof typeof ui] ?? {}

// Get all posts
const posts = (await getCollection('posts'))
  .filter(post => !post.data.draft)
  .filter(post => post.data.lang === currentLang || post.data.lang === '')
  .sort((a, b) => b.data.published.getTime() - a.data.published.getTime())

// Group posts by year
const postsByYear = posts.reduce((acc, post) => {
  const year = post.data.published.getFullYear()
  if (!acc[year]) {
    acc[year] = []
  }
  acc[year].push(post)
  return acc
}, {} as Record<number, typeof posts>)

const years = Object.keys(postsByYear).map(Number).sort((a, b) => b - a)
---

<Layout>
  <!-- Decorative Line -->
  <div class="uno-decorative-line" />
  
  <div class="heti mb-12">
    <h1>{currentUI.timeline}</h1>
  </div>

  <div class="max-w-[var(--content-width)] mx-auto px-4 sm:px-0">
    <div class="relative pl-8 border-l border-gray-200 dark:border-gray-800 space-y-12">
      {years.map(year => (
        <div class="relative">
          <span class="absolute -left-[39px] top-0 flex items-center justify-center w-5 h-5 rounded-full bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-xs font-bold text-gray-500 dark:text-gray-400">
            
          </span>
          <h2 class="text-2xl font-bold mb-6 mt-[-6px] opacity-80">{year}</h2>
          
          <div class="space-y-8">
            {postsByYear[year].map(post => (
              <article class="group relative">
                <div class="absolute -left-[37px] top-2 w-3 h-3 rounded-full bg-primary/20 group-hover:bg-primary transition-colors duration-300"></div>
                <div class="flex flex-col sm:flex-row sm:items-baseline gap-2 sm:gap-4">
                  <time class="font-mono text-sm text-gray-500 dark:text-gray-400 shrink-0 w-24">
                    {post.data.published.toLocaleDateString(currentLang, { month: '2-digit', day: '2-digit' })}
                  </time>
                  <h3 class="text-lg font-medium leading-tight">
                    <a href={getPostPath(post.data.abbrlink || post.id, currentLang)} class="hover:text-primary transition-colors">
                      {post.data.title}
                    </a>
                  </h3>
                </div>
              </article>
            ))}
          </div>
        </div>
      ))}
    </div>
  </div>
</Layout>
