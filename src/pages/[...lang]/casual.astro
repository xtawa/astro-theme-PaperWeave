---
import { getCollection, render } from 'astro:content'
import { allLocales } from '@/config'
import { getLangFromLocale, getLangRouteParam } from '@/i18n/lang'
import Layout from '@/layouts/Layout.astro'

export async function getStaticPaths() {
  return allLocales.map(lang => ({
    params: { lang: getLangRouteParam(lang) },
  }))
}

const currentLang = getLangFromLocale(Astro.currentLocale)
// Get casual page content with different language
const allCasualEntries = await getCollection('casual')
const casualEntry = allCasualEntries.find(entry => entry.data.lang === currentLang)
  ?? allCasualEntries.find(entry => entry.data.lang === '')
const { Content } = casualEntry ? await render(casualEntry) : { Content: null }
---

<Layout>
  <!-- Decorative Line -->
  <div class="uno-decorative-line" />
  <!-- Casual Page Content -->
  <div class="heti mb-12">
    {Content && <Content />}
  </div>

  <!-- Telegram Posts -->
  <div class="max-w-[var(--content-width)] mx-auto px-4 sm:px-0">
    <!-- Loading State -->
    <div id="casual-loading" class="animate-pulse flex flex-col gap-8">
      {[1, 2, 3].map(() => (
        <div class="relative pl-6 border-l-2 border-gray-200 dark:border-gray-800">
          <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-32 mb-4"></div>
          <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-full mb-2"></div>
          <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-2/3"></div>
        </div>
      ))}
    </div>

    <!-- Tags Section -->
    <div id="casual-tags" class="flex flex-wrap gap-2 mb-8 hidden">
      <!-- Tags will be injected here -->
    </div>

    <!-- Content Container -->
    <div id="casual-container" class="flex flex-col gap-8 hidden">
      <!-- Data will be injected here -->
    </div>

    <!-- Error State -->
    <div id="casual-error" class="hidden text-center text-red-500 py-8">
      Failed to load updates.
    </div>
  </div>
</Layout>

<script>
  // Define types for better code assistance (optional in vanilla JS but good for structure)
  interface CasualCache {
    data: any[];
    timestamp: number;
  }

  declare global {
    interface Window {
      __CASUAL_CACHE__?: CasualCache;
    }
  }

  // Main logic wrapper to support View Transitions
  function initCasualPage() {
    const container = document.getElementById('casual-container');
    const tagsContainer = document.getElementById('casual-tags');
    const loading = document.getElementById('casual-loading');
    const error = document.getElementById('casual-error');
    
    // Pagination Controls Container (will be created dynamically)
    let paginationContainer = document.getElementById('casual-pagination');

    // Only run if we are on the casual page
    if (!container || !loading) return;

    let allPostsData: any[] = [];
    let currentFilteredPosts: any[] = [];
    let currentPage = 1;
    const pageSize = 10;

    // Check Cache
    if (window.__CASUAL_CACHE__ && window.__CASUAL_CACHE__.data.length > 0) {
      // Use cached data
      console.log('Using cached casual posts');
      allPostsData = window.__CASUAL_CACHE__.data;
      currentFilteredPosts = allPostsData;
      if (loading) loading.style.display = 'none'; // Hide loader immediately
      renderPage();
    } else {
      // Fetch data
      fetchData();
    }

    async function fetchData() {
      try {
        // Try fetching with trailing slash first due to trailingSlash: 'always' config
        let response = await fetch('/api/casual/');
        
        // If 404, try without slash (just in case)
        if (response.status === 404) {
          response = await fetch('/api/casual');
        }

        if (!response.ok) throw new Error(`Network response was not ok: ${response.status}`);
        
        const posts = await response.json();
        allPostsData = posts;
        currentFilteredPosts = posts;
        
        // Save to Cache
        window.__CASUAL_CACHE__ = {
          data: posts,
          timestamp: Date.now()
        };

        if (loading) loading.style.display = 'none';
        renderPage(true); // Animate only on first fetch

      } catch (err) {
        console.error('Failed to load casual posts:', err);
        if (loading) loading.style.display = 'none';
        if (error) error.classList.remove('hidden');
      }
    }

    function renderPage(animate: boolean = false) {
      if (!container || !tagsContainer) return;
      
      // Clear container (will be refilled by renderPostsList)
      container.innerHTML = '';
      
      // 1. Process and Render Tags (Only once or when data changes, but here we do it on init)
      // Note: We use allPostsData for tag counts to show global stats
      const tagCounts = new Map();
      allPostsData.forEach((post: any) => {
        // Extract tags logic...
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = post.content;
        const rawText = tempDiv.textContent || '';
        const tags = (rawText.match(/#[\p{L}\p{N}_]+/gu) || []).map((t: string) => t.substring(1));
        post.tags = tags; 
        
        tags.forEach((tag: string) => {
          tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
        });
      });

      console.log('Extracted tags:', tagCounts); // Debug log

      if (tagCounts.size > 0) {
        const sortedTags = [...tagCounts.entries()].sort((a, b) => b[1] - a[1]);
        
        let tagsHtml = `<button data-tag="__all__" class="px-4 py-2 text-sm rounded-full transition-all bg-primary text-white border border-primary font-medium shadow-sm">All</button>`;
        
        sortedTags.forEach(([tag, count]) => {
          tagsHtml += `<button data-tag="${tag}" class="px-4 py-2 text-sm rounded-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:border-primary/50 hover:text-primary transition-all text-gray-600 dark:text-gray-300">#${tag} <span class="opacity-60 text-xs ml-1">${count}</span></button>`;
        });
        
        tagsContainer.innerHTML = tagsHtml;
        tagsContainer.classList.remove('hidden');

        tagsContainer.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const target = e.currentTarget as HTMLButtonElement;
            const tag = target.dataset.tag;
            setActiveTag(tag || '__all__');
          });
        });
      } else {
          console.log('No tags found in posts.');
          tagsContainer.classList.add('hidden');
      }

      // 2. Render Posts
      renderPostsList(animate);
      container.classList.remove('hidden');
    }

    function setActiveTag(tag: string) {
      if (!tagsContainer) return;
      tagsContainer.querySelectorAll('button').forEach(b => {
          if (b.dataset.tag === tag) {
              b.className = 'px-4 py-2 text-sm rounded-full transition-all bg-primary text-white border border-primary font-medium shadow-sm';
          } else {
              b.className = 'px-4 py-2 text-sm rounded-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:border-primary/50 hover:text-primary transition-all text-gray-600 dark:text-gray-300';
          }
      });
      
      // Filter logic
      currentFilteredPosts = tag === '__all__' 
        ? allPostsData
        : allPostsData.filter((p: any) => p.tags && p.tags.includes(tag));
      
      // Reset to page 1 on filter change
      currentPage = 1;
      renderPostsList(false);
    }

    function renderPostsList(animate: boolean) {
      if (!container) return;
      container.innerHTML = '';

      if (currentFilteredPosts.length === 0) {
         container.innerHTML = '<div class="text-center opacity-50 py-8">No posts found.</div>';
         renderPaginationControls(); // Update (hide) pagination
         return;
      }

      // Pagination Slice
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const postsToShow = currentFilteredPosts.slice(startIndex, endIndex);

      postsToShow.forEach((post: any) => {
        const article = document.createElement('article');
        const animationClass = animate ? 'animate-fade-in' : '';
        article.className = `relative pl-6 before:absolute before:left-0 before:top-2 before:bottom-2 before:w-[2px] before:bg-primary/30 ${animationClass}`;
        
        const dateStr = new Date(post.timestamp).toLocaleDateString();
        
        let imagesHtml = '';
        if (post.images && post.images.length > 0) {
             const gridClass = post.images.length === 1 ? 'grid-cols-1' : 'grid-cols-2';
             const imgs = post.images.map((img: string) => 
               `<img src="${img}" alt="" loading="lazy" class="rounded-lg w-full h-auto border border-gray-100 dark:border-gray-800 block" />`
             ).join('');
             imagesHtml = `<div class="mt-4 grid gap-2 ${gridClass}">${imgs}</div>`;
        }

        // Clean content logic
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = post.content;
        tempDiv.querySelectorAll('a').forEach(a => {
            if (a.textContent && /^#[\p{L}\p{N}_]+$/u.test(a.textContent.trim())) {
                a.remove();
            }
        });
        const walker = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT);
        let node;
        while (node = walker.nextNode()) {
            if (node.nodeValue) {
                node.nodeValue = node.nodeValue.replace(/#[\p{L}\p{N}_]+/gu, '');
            }
        }
        const contentHtml = tempDiv.innerHTML;

        article.innerHTML = `
          <div class="text-sm text-gray-500 dark:text-gray-400 mb-2 font-mono">
            <a href="${post.link}" target="_blank" rel="noopener noreferrer" class="hover:underline transition-all hover:text-primary"><time datetime="${post.date}">${dateStr}</time></a>
          </div>
          <div class="heti text-base leading-relaxed post-content">${contentHtml}</div>
          ${imagesHtml}
        `;
        
        container.appendChild(article);
      });

      renderPaginationControls();
    }

    function renderPaginationControls() {
      // Remove existing pagination if any
      const existingPagination = document.getElementById('casual-pagination-controls');
      if (existingPagination) existingPagination.remove();

      const totalPages = Math.ceil(currentFilteredPosts.length / pageSize);
      if (totalPages <= 1) return;

      const nav = document.createElement('nav');
      nav.id = 'casual-pagination-controls';
      nav.className = 'flex justify-center gap-4 mt-12';
      
      const prevBtn = document.createElement('button');
      prevBtn.textContent = '← Prev';
      prevBtn.className = `px-4 py-2 rounded-lg transition-colors ${currentPage === 1 ? 'opacity-50 cursor-not-allowed text-gray-400' : 'hover:bg-primary/10 text-primary'}`;
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          renderPostsList(false);
          document.getElementById('casual-tags')?.scrollIntoView({ behavior: 'smooth' });
        }
      };

      const nextBtn = document.createElement('button');
      nextBtn.textContent = 'Next →';
      nextBtn.className = `px-4 py-2 rounded-lg transition-colors ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed text-gray-400' : 'hover:bg-primary/10 text-primary'}`;
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderPostsList(false);
          document.getElementById('casual-tags')?.scrollIntoView({ behavior: 'smooth' });
        }
      };

      const info = document.createElement('span');
      info.className = 'self-center text-sm text-gray-500 font-mono';
      info.textContent = `${currentPage} / ${totalPages}`;

      nav.appendChild(prevBtn);
      nav.appendChild(info);
      nav.appendChild(nextBtn);

      container?.after(nav);
    }
  }

  // Run on initial load
  initCasualPage();

  // Run on view transitions navigation
  document.addEventListener('astro:page-load', initCasualPage);
</script>
